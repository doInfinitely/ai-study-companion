<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Study Companion</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      :root {
        --bg-primary: #0f0f0f;
        --bg-secondary: #1a1a1a;
        --bg-tertiary: #2a2a2a;
        --text-primary: #e8e8e8;
        --text-secondary: #a0a0a0;
        --border-color: #333;
        --accent: #5aa1ff;
        --accent-hover: #4a91ef;
        --sidebar-width: 260px;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
      }
      
      .app-container {
        display: flex;
        height: 100vh;
      }
      
      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
      }
      
      .new-chat-btn {
        width: 100%;
        padding: 12px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .new-chat-btn:hover {
        background: var(--accent-hover);
      }
      
      .logout-btn {
        width: 100%;
        padding: 8px 12px;
        margin-top: 8px;
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .logout-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .conversation-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }
      
      .conversation-item {
        padding: 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 13px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .conversation-item:hover {
        background: var(--bg-tertiary);
      }
      
      .conversation-item.active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      /* Main area */
      .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      /* Chat section */
      .chat-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        height: 100vh;
        overflow: hidden;
      }
      
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }
      
      .message {
        display: flex;
        gap: 12px;
        max-width: 85%;
      }
      
      .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      
      .message.assistant {
        align-self: flex-start;
      }
      
      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
      }
      
      .message.user .message-avatar {
        background: var(--bg-tertiary);
      }
      
      .message-content {
        background: var(--bg-secondary);
        padding: 12px 16px;
        border-radius: 12px;
        line-height: 1.5;
        font-size: 14px;
      }
      
      .message.user .message-content {
        background: var(--accent);
        color: white;
      }
      
      .message.system {
        align-self: center;
        max-width: 100%;
      }
      
      .message.system .message-content {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        font-style: italic;
        text-align: center;
      }
      
      /* Markdown styling */
      .message-content h1,
      .message-content h2,
      .message-content h3,
      .message-content h4,
      .message-content h5,
      .message-content h6 {
        margin: 16px 0 8px 0;
        font-weight: 600;
        line-height: 1.3;
        color: var(--text-primary);
      }
      
      .message-content h1 { font-size: 1.5em; }
      .message-content h2 { font-size: 1.3em; }
      .message-content h3 { font-size: 1.15em; }
      
      .message-content p {
        margin: 8px 0;
      }
      
      .message-content ul,
      .message-content ol {
        margin: 8px 0;
        padding-left: 24px;
      }
      
      .message-content li {
        margin: 4px 0;
      }
      
      .message-content code {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
      }
      
      .message.user .message-content code {
        background: rgba(255, 255, 255, 0.2);
      }
      
      .message-content pre {
        background: rgba(0, 0, 0, 0.05);
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 12px 0;
        border-left: 3px solid var(--accent);
      }
      
      .message-content pre code {
        background: none;
        padding: 0;
        font-size: 0.85em;
        line-height: 1.5;
      }
      
      .message-content blockquote {
        border-left: 3px solid var(--accent);
        padding-left: 12px;
        margin: 12px 0;
        color: var(--text-secondary);
        font-style: italic;
      }
      
      .message-content a {
        color: var(--accent);
        text-decoration: none;
      }
      
      .message-content a:hover {
        text-decoration: underline;
      }
      
      .message-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
      }
      
      .message-content th,
      .message-content td {
        border: 1px solid var(--border-color);
        padding: 8px;
        text-align: left;
      }
      
      .message-content th {
        background: var(--bg-tertiary);
        font-weight: 600;
      }
      
      .message-content hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 16px 0;
      }
      
      .message-content img {
        max-width: 100%;
        border-radius: 8px;
        margin: 8px 0;
      }
      
      .message-content strong {
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .message-content em {
        font-style: italic;
      }
      
      /* Input area */
      .chat-input-area {
        border-top: 1px solid var(--border-color);
        padding: 20px;
        flex-shrink: 0;
        background: var(--bg-primary);
      }
      
      .input-container {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 8px;
      }
      
      .chat-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-size: 14px;
        resize: none;
        max-height: 200px;
        min-height: 24px;
        padding: 8px;
        font-family: inherit;
      }
      
      .input-actions {
        display: flex;
        gap: 4px;
      }
      
      .input-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 8px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 18px;
      }
      
      .input-btn:hover:not(:disabled) {
        background: var(--accent);
        color: white;
      }
      
      .input-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .input-btn.recording {
        background: #ff4444;
        color: white;
        animation: pulse 1.5s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      /* Live2D canvas */
      #live2d-canvas {
        position: fixed;
        right: -17%;
        top: 0;
        width: 45%;
        height: 100vh;
        pointer-events: none;
        z-index: 1;
      }
      
      /* Loading spinner */
      .loading-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 13px;
        padding: 12px;
        flex-shrink: 0;
      }
      
      .loading-indicator.active {
        display: flex;
      }
      
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-color);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Empty state */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 16px;
        color: var(--text-secondary);
        padding: 20px;
      }
      
      .empty-state h2 {
        font-size: 24px;
        color: var(--text-primary);
      }
      
      .empty-state p {
        font-size: 14px;
        text-align: center;
        max-width: 500px;
      }
      
      /* Customization Panel */
      .customize-btn {
        position: fixed;
        bottom: 20px;
        left: var(--sidebar-width);
        margin-left: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: all 0.2s;
        z-index: 10;
      }
      
      .customize-btn:hover {
        background: var(--accent-hover);
        transform: scale(1.1);
      }
      
      .customize-panel {
        position: fixed;
        left: 0;
        top: 0;
        width: 380px;
        height: 100vh;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        transition: transform 0.3s;
        transform: translateX(calc(-100% - var(--sidebar-width)));
        z-index: 50;
        overflow-y: auto;
        padding: 20px;
      }
      
      .customize-panel.open {
        transform: translateX(var(--sidebar-width));
      }
      
      .customize-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      
      .customize-header h3 {
        margin: 0;
        color: var(--text-primary);
      }
      
      .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
        padding: 4px 8px;
      }
      
      .close-btn:hover {
        color: var(--text-primary);
      }
      
      .customize-section {
        margin-bottom: 24px;
      }
      
      .customize-section h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .customize-control {
        margin-bottom: 16px;
      }
      
      .customize-control label {
        display: block;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }
      
      .customize-control select,
      .customize-control input[type="range"] {
        width: 100%;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 8px;
        border-radius: 6px;
        font-size: 13px;
      }
      
      .customize-control input[type="range"] {
        padding: 0;
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
      }
      
      .customize-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
      }
      
      .customize-control input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        border: none;
      }
      
      .range-value {
        display: inline-block;
        float: right;
        font-size: 12px;
        color: var(--text-secondary);
      }
      
      .reset-btn {
        width: 100%;
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin-top: 8px;
      }
      
      .reset-btn:hover {
        background: var(--bg-primary);
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          position: absolute;
          left: -100%;
          width: 80%;
          z-index: 100;
          transition: left 0.3s;
        }
        
        .sidebar.open {
          left: 0;
        }
        
        #live2d-canvas {
          display: none;
        }
        
        .customize-panel {
          width: 90%;
          transform: translateX(-100%);
        }
        
        .customize-panel.open {
          transform: translateX(0);
        }
        
        .customize-btn {
          left: 10px;
          bottom: 80px;
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <button class="new-chat-btn" id="newChatBtn">+ New Conversation</button>
          <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
        </div>
        <div class="conversation-list" id="conversationList">
          <!-- Conversations will be loaded here -->
        </div>
      </div>
      
      <!-- Main chat area -->
      <div class="main-area">
        <div class="chat-section">
          <div class="chat-messages" id="chatMessages">
            <div class="empty-state" id="emptyState">
              <h2>üëã Welcome to Your AI Study Companion</h2>
              <p>I'm here to help you achieve your learning goals and stay motivated. Start a conversation and let's work together on your educational journey!</p>
            </div>
          </div>
          
          <div class="loading-indicator" id="loadingIndicator">
            <div class="spinner"></div>
            <span>Thinking...</span>
          </div>
          
          <div class="chat-input-area">
            <div class="input-container">
              <textarea 
                id="chatInput" 
                class="chat-input" 
                placeholder="Ask me anything about your studies..."
                rows="1"
              ></textarea>
              <div class="input-actions">
                <button class="input-btn" id="voiceBtn" title="Voice input">üé§</button>
                <button class="input-btn" id="sendBtn" title="Send message">‚û§</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Live2D Canvas -->
    <canvas id="live2d-canvas"></canvas>
    
    <!-- Customize Button -->
    <button class="customize-btn" id="customizeBtn" title="Customize Avatar">‚öôÔ∏è</button>
    
    <!-- Customization Panel -->
    <div class="customize-panel" id="customizePanel">
      <div class="customize-header">
        <h3>Customize Avatar</h3>
        <button class="close-btn" id="closeCustomizeBtn">‚úï</button>
      </div>
      
      <div class="customize-section">
        <h4>üë§ Face Features</h4>
        
        <div class="customize-control">
          <label>Pupil Style (Left) <span class="range-value" id="pupilStyleLValue">0</span></label>
          <input type="range" id="pupilStyleL" min="0" max="8" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Pupil Style (Right) <span class="range-value" id="pupilStyleRValue">0</span></label>
          <input type="range" id="pupilStyleR" min="0" max="8" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Iris Color (Left) <span class="range-value" id="irisColorLValue">0</span></label>
          <input type="range" id="irisColorL" min="0" max="2" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Iris Color (Right) <span class="range-value" id="irisColorRValue">0</span></label>
          <input type="range" id="irisColorR" min="0" max="2" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Eyebrow Style <span class="range-value" id="eyebrowStyleValue">0</span></label>
          <input type="range" id="eyebrowStyle" min="0" max="6" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Nose Style <span class="range-value" id="noseStyleValue">0</span></label>
          <input type="range" id="noseStyle" min="0" max="7" value="0" step="1">
        </div>
      </div>
      
      <div class="customize-section">
        <h4>üéÄ Accessories</h4>
        
        <div class="customize-control">
          <label>Horns <span class="range-value" id="hornsValue">0</span></label>
          <input type="range" id="horns" min="0" max="3" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Head Wings <span class="range-value" id="headWingsValue">0</span></label>
          <input type="range" id="headWings" min="0" max="2" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Back Wings <span class="range-value" id="backWingsValue">0</span></label>
          <input type="range" id="backWings" min="0" max="5" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Ears <span class="range-value" id="earsValue">0</span></label>
          <input type="range" id="ears" min="0" max="10" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Halo/Bow <span class="range-value" id="haloBowValue">0</span></label>
          <input type="range" id="haloBow" min="0" max="2" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Hat <span class="range-value" id="hatValue">0</span></label>
          <input type="range" id="hat" min="0" max="5" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Glasses/Eyepatch <span class="range-value" id="glassesValue">0</span></label>
          <input type="range" id="glasses" min="0" max="7" value="0" step="1">
        </div>
      </div>
      
      <div class="customize-section">
        <h4>üëî Clothing</h4>
        
        <div class="customize-control">
          <label>Shirt Style <span class="range-value" id="shirtValue">0</span></label>
          <input type="range" id="shirt" min="0" max="6" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Neck Accessory <span class="range-value" id="neckAccessoryValue">0</span></label>
          <input type="range" id="neckAccessory" min="0" max="4" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Sweater Stripes <span class="range-value" id="sweaterValue">0</span></label>
          <input type="range" id="sweater" min="0" max="1" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Shorts/Skirt <span class="range-value" id="bottomValue">0</span></label>
          <input type="range" id="bottom" min="0" max="1" value="0" step="0.1">
        </div>
      </div>
      
      <div class="customize-section">
        <h4>üíá Hair Style</h4>
        
        <div class="customize-control">
          <label>Central Hair <span class="range-value" id="centralHairValue">0</span></label>
          <input type="range" id="centralHair" min="0" max="16" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Left Hair <span class="range-value" id="leftHairValue">0</span></label>
          <input type="range" id="leftHair" min="0" max="14" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Right Hair <span class="range-value" id="rightHairValue">0</span></label>
          <input type="range" id="rightHair" min="0" max="14" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Back Hair <span class="range-value" id="backHairValue">0</span></label>
          <input type="range" id="backHair" min="0" max="12" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Back Left Hair <span class="range-value" id="backLeftHairValue">0</span></label>
          <input type="range" id="backLeftHair" min="0" max="6" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Back Right Hair <span class="range-value" id="backRightHairValue">0</span></label>
          <input type="range" id="backRightHair" min="0" max="6" value="0" step="1">
        </div>
        
        <div class="customize-control">
          <label>Ahoge (Hair Strand) <span class="range-value" id="ahogeValue">0</span></label>
          <input type="range" id="ahoge" min="0" max="10" value="0" step="1">
        </div>
      </div>
      
      <div class="customize-section">
        <h4>üìè Hair Length & Width</h4>
        
        <div class="customize-control">
          <label>Central Hair Length <span class="range-value" id="centralHairLengthValue">0</span></label>
          <input type="range" id="centralHairLength" min="-1" max="1" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Central Hair Width <span class="range-value" id="centralHairWidthValue">0</span></label>
          <input type="range" id="centralHairWidth" min="-1" max="1" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Left Hair Length <span class="range-value" id="leftHairLengthValue">0</span></label>
          <input type="range" id="leftHairLength" min="-1" max="1" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Left Hair Width <span class="range-value" id="leftHairWidthValue">0</span></label>
          <input type="range" id="leftHairWidth" min="-1" max="1" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Right Hair Length <span class="range-value" id="rightHairLengthValue">0</span></label>
          <input type="range" id="rightHairLength" min="-1" max="1" value="0" step="0.1">
        </div>
        
        <div class="customize-control">
          <label>Right Hair Width <span class="range-value" id="rightHairWidthValue">0</span></label>
          <input type="range" id="rightHairWidth" min="-1" max="1" value="0" step="0.1">
        </div>
      </div>
      
      <button class="reset-btn" id="resetBtn">Reset to Default</button>
    </div>
    
    <!-- Cubism Core -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <!-- Pixi v6 -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
    <!-- pixi-live2d-display cubism4 -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>
    
    <script type="module">
      // Import Supabase
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
      
      // Import marked for markdown rendering
      import { marked } from 'https://cdn.jsdelivr.net/npm/marked@11.1.0/lib/marked.esm.js';
      
      // Configure marked options
      marked.setOptions({
        breaks: true, // Convert \n to <br>
        gfm: true, // GitHub Flavored Markdown
        headerIds: false, // Don't add IDs to headers
        mangle: false, // Don't escape autolinked email addresses
      });
      
      // Initialize Supabase
      const supabase = createClient(
        import.meta.env.VITE_SUPABASE_URL || 'YOUR_SUPABASE_URL',
        import.meta.env.VITE_SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY'
      );
      
      // Main chat application
      let currentConversationId = null;
      let currentUserId = null;
      let isRecording = false;
      let mediaRecorder = null;
      let audioChunks = [];
      let live2dController = null;
      
      // Use production API in deployment, local in dev
      const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8787' : '/api';
      
      // Check authentication
      async function checkAuth() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = '/auth.html';
          return false;
        }
        currentUserId = user.id;
        return true;
      }
      
      // Logout function
      async function logout() {
        await supabase.auth.signOut();
        window.location.href = '/auth.html';
      }
      
      // DOM elements
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const voiceBtn = document.getElementById('voiceBtn');
      const newChatBtn = document.getElementById('newChatBtn');
      const conversationList = document.getElementById('conversationList');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const emptyState = document.getElementById('emptyState');
      
      // Initialize Live2D
      async function initLive2D() {
        window.PIXI = PIXI;
        const canvas = document.getElementById('live2d-canvas');
        const app = new PIXI.Application({
          view: canvas,
          width: window.innerWidth * 0.45,
          height: window.innerHeight,
          backgroundAlpha: 0,
          antialias: true
        });
        
        const { Live2DModel } = PIXI.live2d;
        const model = await Live2DModel.from('/models/MO.v2.6.2/MO.model3.json');
        app.stage.addChild(model);
        
        const core = model.internalModel.coreModel;
        
        // Position model on right side
        model.anchor.set(0.5, 0.5);
        const scale = Math.min(
          (app.renderer.screen.width * 0.8) / model.width,
          (app.renderer.screen.height * 0.8) / model.height
        );
        model.scale.set(scale);
        model.position.set(
          app.renderer.screen.width / 2,
          app.renderer.screen.height - model.height * scale / 2 - 20
        );
        
        // Idle animation - subtle sway
        app.ticker.add(() => {
          const t = performance.now() * 0.001;
          try {
            core.setParameterValueById('ParamAngleZ', Math.sin(t) * 2.0);
          } catch {}
        });
        
        // Resize handler
        window.addEventListener('resize', () => {
          app.renderer.resize(window.innerWidth * 0.45, window.innerHeight);
          const scale = Math.min(
            (app.renderer.screen.width * 0.8) / model.width,
            (app.renderer.screen.height * 0.8) / model.height
          );
          model.scale.set(scale);
          model.position.set(
            app.renderer.screen.width / 2,
            app.renderer.screen.height - model.height * scale / 2 - 20
          );
        });
        
        return { app, model, core };
      }
      
      // API functions
      async function apiRequest(endpoint, data) {
        const res = await fetch(`${API_BASE}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const error = await res.text();
          throw new Error(`API error: ${error}`);
        }
        return res.json();
      }
      
      async function loadConversations() {
        try {
          const res = await fetch(`${API_BASE}/conversations?userId=${currentUserId}`);
          if (!res.ok) throw new Error('Failed to load conversations');
          const conversations = await res.json();
          
          conversationList.innerHTML = '';
          conversations.forEach(conv => {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            if (conv.id === currentConversationId) {
              item.classList.add('active');
            }
            item.textContent = conv.title || 'New Conversation';
            item.dataset.id = conv.id;
            item.onclick = () => loadConversation(conv.id);
            conversationList.appendChild(item);
          });
        } catch (err) {
          console.error('Failed to load conversations:', err);
        }
      }
      
      async function createNewConversation() {
        try {
          const res = await fetch(`${API_BASE}/conversations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUserId }),
          });
          if (!res.ok) throw new Error('Failed to create conversation');
          const data = await res.json();
          
          currentConversationId = data.id;
          await loadConversations();
          chatMessages.innerHTML = '';
          emptyState.style.display = 'flex';
          
          // Get initial greeting
          await sendMessage('', true);
          
          // Add a helpful note about audio if this is truly the first conversation
          const allRes = await fetch(`${API_BASE}/conversations?userId=${currentUserId}`);
          const allConversations = await allRes.json();
          if (allConversations.length === 1) {
            setTimeout(() => {
              addMessageToUI('system', 'Tip: If you don\'t hear my voice, click anywhere to enable audio. Some browsers block autoplay.');
            }, 2000);
          }
        } catch (err) {
          console.error('Failed to create conversation:', err);
        }
      }
      
      async function loadConversation(conversationId) {
        try {
          const { data, error } = await supabase
            .from('conversations')
            .select('*')
            .eq('id', conversationId)
            .eq('user_id', currentUserId)
            .single();
          
          if (error) throw error;
          
          currentConversationId = conversationId;
          chatMessages.innerHTML = '';
          emptyState.style.display = 'none';
          
          (data.messages || []).forEach(msg => {
            addMessageToUI(msg.role, msg.content, false);
          });
          
          // Update active state
          document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.toggle('active', item.dataset.id === conversationId);
          });
          
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (err) {
          console.error('Failed to load conversation:', err);
        }
      }
      
      async function sendMessage(text, isInitial = false) {
        if (!text.trim() && !isInitial) return;
        if (!currentConversationId) {
          await createNewConversation();
          if (!text.trim()) return;
        }
        
        emptyState.style.display = 'none';
        
        // Add user message to UI
        if (!isInitial) {
          addMessageToUI('user', text);
          chatInput.value = '';
        }
        
        // Show loading
        loadingIndicator.classList.add('active');
        sendBtn.disabled = true;
        
        try {
          const res = await fetch(`${API_BASE}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              conversationId: currentConversationId,
              message: text || 'Hi! I\'m ready to learn.',
              userId: currentUserId,
            }),
          });
          
          if (!res.ok) {
            const error = await res.text();
            throw new Error(`Chat error: ${error}`);
          }
          
          const data = await res.json();
          
          console.log('=== FRONTEND RESPONSE ===');
          console.log('  data.conversationTitle:', data.conversationTitle);
          console.log('  currentConversationId:', currentConversationId);
          
          // Add assistant response
          addMessageToUI('assistant', data.response);
          
          // Speak the response with Live2D
          if (data.response) {
            await speakText(data.response);
          }
          
          // Update title immediately if it changed
          if (data.conversationTitle) {
            console.log('‚úì Updating title in UI to:', data.conversationTitle);
            const conversationItem = document.querySelector(`[data-id="${currentConversationId}"]`);
            console.log('  Found conversation item:', conversationItem);
            if (conversationItem) {
              conversationItem.textContent = data.conversationTitle;
              console.log('  ‚úì Updated item text');
            } else {
              console.log('  ‚úó Could not find conversation item!');
            }
            // Reload full list to ensure it's sorted correctly and persisted
            console.log('  Reloading conversation list...');
            await loadConversations();
          } else {
            console.log('‚úó No conversationTitle in response');
          }
          console.log('=== END FRONTEND ===');
        } catch (err) {
          console.error('Failed to send message:', err);
          addMessageToUI('system', 'Sorry, I encountered an error. Please try again.');
        } finally {
          loadingIndicator.classList.remove('active');
          sendBtn.disabled = false;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
      
      function addMessageToUI(role, content, scroll = true) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        if (role !== 'system') {
          const avatar = document.createElement('div');
          avatar.className = 'message-avatar';
          avatar.textContent = role === 'user' ? 'U' : 'AI';
          messageDiv.appendChild(avatar);
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        // Render markdown for assistant messages
        if (role === 'assistant') {
          contentDiv.innerHTML = marked.parse(content);
        } else {
          contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(contentDiv);
        
        chatMessages.appendChild(messageDiv);
        
        if (scroll) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
      
      // ---------- Mouth Amplitude Driver ----------
      class MouthAmplitudeDriver {
        constructor(core, opts={}) {
          const d = { paramId:'ParamMouthOpenY', gain:1.6, floor:0.012, attackMs:20, releaseMs:20, max:1.0, gamma:0.55 };
          this.opt = Object.assign(d, opts);
          this.core=core; this.ctx=null; this.src=null; this.hp=null; this.lp=null; this.an=null;
          this.raf=0; this.running=false; this.prev=0; this.restoreTo=0;
        }
        async ensureContext(){ 
          if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); 
          if(this.ctx.state==='suspended') await this.ctx.resume(); 
          return this.ctx; 
        }
        async startFor(audioEl, restoreTo=0){
          this.stop(); this.restoreTo=Number(restoreTo)||0;
          const ctx = await this.ensureContext();
          const src = this.src = ctx.createMediaElementSource(audioEl);
          const hp = this.hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=200; hp.Q.value=0.707;
          const lp = this.lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3200; lp.Q.value=0.707;
          const an = this.an = ctx.createAnalyser(); an.fftSize=1024; an.smoothingTimeConstant=0.4;
          src.connect(ctx.destination); src.connect(hp); hp.connect(lp); lp.connect(an);
          const buf = new Float32Array(an.fftSize); this.running=true;
          const tick = () => {
            if (!this.running) return;
            an.getFloatTimeDomainData(buf);
            let sum=0; for (let i=0;i<buf.length;i++){ const x=buf[i]; sum+=x*x; }
            const rms = Math.sqrt(sum/buf.length);
            const atk = Math.exp(-1/Math.max(1,this.opt.attackMs)), rel = Math.exp(-1/Math.max(1,this.opt.releaseMs));
            const env = rms > this.prev ? atk*this.prev + (1-atk)*rms : rel*this.prev + (1-rel)*rms; this.prev = env;
            let n = Math.max(0, env - this.opt.floor) / Math.max(1e-6,(1 - this.opt.floor));
            if (this.opt.gamma && this.opt.gamma !== 1) n = Math.pow(n, this.opt.gamma);
            const y = Math.min(this.opt.max, n * this.opt.gain);
            try { this.core.setParameterValueById(this.opt.paramId, y); } catch {}
            this.raf = requestAnimationFrame(tick);
          };
          this.raf = requestAnimationFrame(tick);
        }
        stop(){
          this.running=false; if(this.raf) cancelAnimationFrame(this.raf); this.raf=0;
          try{ this.src?.disconnect(); this.hp?.disconnect(); this.lp?.disconnect(); this.an?.disconnect(); }catch{}
          this.src=this.hp=this.lp=this.an=null;
          try{ this.core.setParameterValueById(this.opt.paramId, this.restoreTo); }catch{}
        }
      }
      
      // ---------- Emotion Layer ----------
      function clamp01(x){ return Math.min(1, Math.max(0, x)); }
      function lerp(a,b,t){ return a + (b-a) * t; }
      
      function makeEmotionApplier(core) {
        const affected = [
          'ParamEyeLSmile','ParamEyeRSmile','ParamMouthForm',
          'Param250','Param254','Param251','Param252','Param255','Param258',
          'Param48','Param47','ParamEyeLOpen','ParamEyeROpen'
        ];
        const startVals = new Map();
        
        function snapshotStart() {
          startVals.clear();
          affected.forEach(id => {
            try { startVals.set(id, core.getParameterValueById(id) ?? 0); } catch {}
          });
        }
        
        function targets(e) {
          const H = clamp01(e.happiness||0);
          const C = clamp01(e.confused||0);
          const A = clamp01(e.annoyed||0);
          const G = clamp01(e.angry||0);
          const S = clamp01(e.sad||0);
          
          const t = {};
          // happiness
          t.ParamEyeLSmile = H; t.ParamEyeRSmile = H;
          t.ParamMouthForm = lerp(0, 0.45, H);
          t.Param255 = lerp(0, 0.6, H);
          t.Param258 = lerp(0, 0.35, H);
          
          // confused
          t.Param250 = lerp(0, 1.0, C);
          t.Param48  = lerp(0, 0.5, C);
          
          // annoyed
          t.Param251 = lerp(0, 0.8, A);
          t.Param47  = (t.Param47 ?? 0) + lerp(0, -0.25, A);
          
          // angry
          t.Param252 = lerp(0, 1.0, G);
          t.Param47  = (t.Param47 ?? 0) + lerp(0, -0.55, G);
          
          // sad
          t.ParamEyeLOpen = clamp01((startVals.get('ParamEyeLOpen') ?? 1) * (1 - 0.8*S));
          t.ParamEyeROpen = clamp01((startVals.get('ParamEyeROpen') ?? 1) * (1 - 0.8*S));
          t.ParamMouthForm = (t.ParamMouthForm ?? 0) + lerp(0, -0.35, S);
          return t;
        }
        
        let raf = 0, stopped = true;
        function animateTo(map, ms=260){
          const keys = Object.keys(map);
          const from = new Map(); keys.forEach(k => from.set(k, startVals.get(k) ?? core.getParameterValueById(k) ?? 0));
          const to   = new Map(); keys.forEach(k => to.set(k, map[k]));
          const t0 = performance.now(); stopped=false;
          
          const tick = now => {
            if (stopped) return;
            const k = Math.min(1, (now - t0)/ms);
            keys.forEach(id => {
              const a = from.get(id), b = to.get(id);
              const v = a + (b - a) * (k*(2-k));
              try { core.setParameterValueById(id, v); } catch {}
            });
            if (k < 1) raf = requestAnimationFrame(tick);
          };
          raf = requestAnimationFrame(tick);
        }
        
        return {
          apply(emotions) {
            snapshotStart();
            animateTo(targets(emotions), 260);
          },
          clear() {
            if (raf) cancelAnimationFrame(raf); raf=0; stopped=true;
            startVals.forEach((v,id) => { try { core.setParameterValueById(id, v); } catch {} });
          }
        };
      }
      
      let mouthDriver = null;
      let emotionLayer = null;
      
      // Strip markdown and emojis for TTS
      function cleanTextForTTS(text) {
        if (!text) return '';
        
        let cleaned = text;
        
        // Remove markdown formatting
        cleaned = cleaned.replace(/\*\*([^*]+)\*\*/g, '$1');  // Bold
        cleaned = cleaned.replace(/\*([^*]+)\*/g, '$1');      // Italic
        cleaned = cleaned.replace(/\_\_([^_]+)\_\_/g, '$1');  // Bold underscore
        cleaned = cleaned.replace(/\_([^_]+)\_/g, '$1');      // Italic underscore
        cleaned = cleaned.replace(/\~\~([^~]+)\~\~/g, '$1');  // Strikethrough
        cleaned = cleaned.replace(/\`\`\`[^`]*\`\`\`/g, '');  // Code blocks
        cleaned = cleaned.replace(/\`([^`]+)\`/g, '$1');      // Inline code
        cleaned = cleaned.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1'); // Links
        cleaned = cleaned.replace(/^#+\s+/gm, '');            // Headers
        cleaned = cleaned.replace(/^\-\s+/gm, '');            // List bullets
        cleaned = cleaned.replace(/^\d+\.\s+/gm, '');         // Numbered lists
        
        // Remove emojis (most common ranges)
        cleaned = cleaned.replace(/[\u{1F600}-\u{1F64F}]/gu, ''); // Emoticons
        cleaned = cleaned.replace(/[\u{1F300}-\u{1F5FF}]/gu, ''); // Symbols & pictographs
        cleaned = cleaned.replace(/[\u{1F680}-\u{1F6FF}]/gu, ''); // Transport & map
        cleaned = cleaned.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, ''); // Flags
        cleaned = cleaned.replace(/[\u{2600}-\u{26FF}]/gu, '');   // Misc symbols
        cleaned = cleaned.replace(/[\u{2700}-\u{27BF}]/gu, '');   // Dingbats
        cleaned = cleaned.replace(/[\u{FE00}-\u{FE0F}]/gu, '');   // Variation selectors
        cleaned = cleaned.replace(/[\u{1F900}-\u{1F9FF}]/gu, ''); // Supplemental symbols
        cleaned = cleaned.replace(/[\u{1FA00}-\u{1FA6F}]/gu, ''); // Extended pictographs
        
        // Clean up multiple spaces and trim
        cleaned = cleaned.replace(/\s+/g, ' ').trim();
        
        return cleaned;
      }
      
      async function speakText(text) {
        if (!text || !text.trim() || !live2dController) return;
        
        try {
          // Clean text for TTS (remove emojis and markdown)
          const cleanedText = cleanTextForTTS(text);
          if (!cleanedText) return;
          
          // Get TTS audio
          const ttsRes = await fetch(`${API_BASE}/tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: cleanedText }),
          });
          
          if (!ttsRes.ok) {
            console.error('TTS failed');
            return;
          }
          
          const audioBlob = await ttsRes.blob();
          const url = URL.createObjectURL(audioBlob);
          
          // Get emotion
          let emotionData = { emotion: 'neutral' };
          try {
            const emotionRes = await fetch(`${API_BASE}/emotion`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text }),
            });
            if (emotionRes.ok) {
              emotionData = await emotionRes.json();
            }
          } catch (e) {
            console.warn('Emotion detection failed, using default', e);
          }
          
          const emotions = {
            happy: emotionData.emotion === 'happy' ? 1.0 : 0.2,
            sad: emotionData.emotion === 'sad' ? 1.0 : 0.0,
            angry: emotionData.emotion === 'angry' ? 1.0 : 0.0,
            surprised: emotionData.emotion === 'surprised' ? 1.0 : 0.0,
            confused: emotionData.emotion === 'thoughtful' ? 0.5 : 0.0,
            annoyed: emotionData.emotion === 'angry' ? 0.5 : 0.0,
          };
          
          const audio = new Audio(url);
          audio.preload = 'auto';
          audio.crossOrigin = 'anonymous';
          
          // Setup mouth driver and emotions
          const core = live2dController.core;
          const preMouth = core.getParameterValueById('ParamMouthOpenY') || 0;
          
          // When audio starts playing
          audio.addEventListener('playing', async () => {
            try {
              // Start mouth animation
              if (mouthDriver) {
                await mouthDriver.ensureContext();
                await mouthDriver.startFor(audio, preMouth);
              }
              // Apply emotions
              if (emotionLayer) {
                emotionLayer.apply(emotions);
              }
            } catch (err) {
              console.warn('Animation setup failed:', err);
            }
          }, { once: true });
          
          // When audio ends
          audio.addEventListener('ended', () => {
            URL.revokeObjectURL(url);
            
            // Stop mouth animation
            if (mouthDriver) {
              mouthDriver.stop();
            }
            
            // Clear emotions after a delay
            if (emotionLayer) {
              setTimeout(() => {
                emotionLayer.clear();
              }, 500);
            }
          }, { once: true });
          
          // Play with better error handling
          try {
            await audio.play();
          } catch (playErr) {
            console.warn('Audio autoplay blocked. User interaction may be required.', playErr);
          }
        } catch (err) {
          console.error('Failed to speak:', err);
        }
      }
      
      async function startVoiceRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioChunks = [];
          
          // Try to use audio/webm with opus codec, fallback to whatever is available
          let mimeType = 'audio/webm;codecs=opus';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'audio/webm';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
              mimeType = 'audio/ogg;codecs=opus';
              if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'audio/mp4';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                  mimeType = ''; // Let browser choose
                }
              }
            }
          }
          
          console.log('Recording with MIME type:', mimeType || 'browser default');
          
          mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
          mediaRecorder.onstop = async () => {
            const actualMimeType = mediaRecorder.mimeType;
            const audioBlob = new Blob(audioChunks, { type: actualMimeType });
            console.log('Recording stopped. Blob type:', audioBlob.type, 'Size:', audioBlob.size);
            await transcribeAudio(audioBlob);
            stream.getTracks().forEach(track => track.stop());
          };
          
          mediaRecorder.start();
          isRecording = true;
          voiceBtn.classList.add('recording');
        } catch (err) {
          console.error('Failed to start recording:', err);
          alert('Failed to access microphone. Please check permissions.');
        }
      }
      
      function stopVoiceRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          isRecording = false;
          voiceBtn.classList.remove('recording');
        }
      }
      
      async function transcribeAudio(audioBlob) {
        try {
          loadingIndicator.classList.add('active');
          
          console.log('üìù Transcribing audio:', audioBlob.size, 'bytes', audioBlob.type);
          
          const formData = new FormData();
          formData.append('audio', audioBlob, 'recording.webm');
          
          const res = await fetch(`${API_BASE}/transcribe`, {
            method: 'POST',
            body: formData
          });
          
          if (!res.ok) {
            const errorText = await res.text();
            console.error('Transcription error response:', errorText);
            throw new Error(`Transcription failed: ${res.status} ${errorText}`);
          }
          
          const data = await res.json();
          console.log('‚úì Transcription result:', data.text);
          
          chatInput.value = data.text;
          
          // Auto-send if there's text
          if (data.text.trim()) {
            await sendMessage(data.text);
          } else {
            addMessageToUI('system', 'No speech detected. Please try again.');
          }
        } catch (err) {
          console.error('Failed to transcribe:', err);
          addMessageToUI('system', `Sorry, transcription failed: ${err.message}. Please try typing instead.`);
        } finally {
          loadingIndicator.classList.remove('active');
        }
      }
      
      // Event listeners
      sendBtn.onclick = () => sendMessage(chatInput.value);
      chatInput.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(chatInput.value);
        }
      };
      
      voiceBtn.onclick = () => {
        if (isRecording) {
          stopVoiceRecording();
        } else {
          startVoiceRecording();
        }
      };
      
      newChatBtn.onclick = createNewConversation;
      
      // Auto-resize textarea
      chatInput.oninput = () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
      };
      
      // ---------- Avatar Customization ----------
      const customizationParams = {
        // Face features - need to control BOTH left and right
        pupilStyleL: { id: 'Param36', range: [0, 8], sync: 'pupilStyleR' },
        pupilStyleR: { id: 'Param38', range: [0, 8], sync: 'pupilStyleL' },
        irisColorL: { id: 'Param42', range: [0, 2], sync: 'irisColorR' },
        irisColorR: { id: 'Param43', range: [0, 2], sync: 'irisColorL' },
        eyebrowStyle: { id: 'Param57', range: [0, 6] },
        noseStyle: { id: 'Param6', range: [0, 7] },
        
        // Accessories
        horns: { id: 'Param152', range: [0, 3] },
        headWings: { id: 'Param262', range: [0, 2] },
        backWings: { id: 'Param325', range: [0, 5] },
        ears: { id: 'Param151', range: [0, 10] },
        haloBow: { id: 'Param208', range: [0, 2] },
        hat: { id: 'Param314', range: [0, 5] },
        glasses: { id: 'Param153', range: [0, 7] },
        
        // Clothing
        shirt: { id: 'Param307', range: [0, 6] },
        neckAccessory: { id: 'Param308', range: [0, 4] },
        sweater: { id: 'Param137', range: [0, 1] },
        bottom: { id: 'Param192', range: [0, 1] },
        
        // Hair styles
        centralHair: { id: 'Param20', range: [0, 16] },
        leftHair: { id: 'Param102', range: [0, 14] },
        rightHair: { id: 'Param268', range: [0, 14] },
        ahoge: { id: 'Param19', range: [0, 10] },
        backHair: { id: 'Param117', range: [0, 12] },
        backLeftHair: { id: 'Param131', range: [0, 6] },
        backRightHair: { id: 'Param134', range: [0, 6] },
        
        // Hair length & width
        centralHairLength: { id: 'Param5', range: [-1, 1] },
        centralHairWidth: { id: 'Param140', range: [-1, 1] },
        leftHairLength: { id: 'Param100', range: [-1, 1] },
        leftHairWidth: { id: 'Param136', range: [-1, 1] },
        rightHairLength: { id: 'Param101', range: [-1, 1] },
        rightHairWidth: { id: 'Param135', range: [-1, 1] }
      };
      
      function setupCustomization() {
        if (!live2dController || !live2dController.core) {
          console.error('Live2D controller not ready for customization');
          return;
        }
        
        const customizeBtn = document.getElementById('customizeBtn');
        const customizePanel = document.getElementById('customizePanel');
        const closeBtn = document.getElementById('closeCustomizeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const core = live2dController.core;
        
        // Debug: List all available parameters
        console.log('üìã Checking parameter availability:');
        Object.keys(customizationParams).forEach(key => {
          const param = customizationParams[key];
          try {
            const currentValue = core.getParameterValueById(param.id);
            console.log(`  ‚úì ${key}: ${param.id} = ${currentValue}`);
          } catch (err) {
            console.warn(`  ‚úó ${key}: ${param.id} NOT FOUND`);
          }
        });
        
        // Toggle panel
        customizeBtn.onclick = () => {
          customizePanel.classList.toggle('open');
        };
        
        closeBtn.onclick = () => {
          customizePanel.classList.remove('open');
        };
        
        // Setup each control
        Object.keys(customizationParams).forEach(key => {
          const input = document.getElementById(key);
          const valueDisplay = document.getElementById(key + 'Value');
          const param = customizationParams[key];
          
          if (!input || !valueDisplay) {
            console.warn(`Missing control for ${key}`);
            return;
          }
          
          // Update display and model
          input.oninput = () => {
            const value = parseFloat(input.value);
            const step = parseFloat(input.step) || 1;
            const decimals = step < 1 ? 1 : 0;
            valueDisplay.textContent = value.toFixed(decimals);
            
            try {
              core.setParameterValueById(param.id, value);
              console.log(`‚úì Set ${param.id} to ${value}`);
              
              // Sync paired parameters (e.g., left and right pupils)
              if (param.sync) {
                const syncParam = customizationParams[param.sync];
                if (syncParam) {
                  const syncInput = document.getElementById(param.sync);
                  const syncDisplay = document.getElementById(param.sync + 'Value');
                  if (syncInput && syncDisplay) {
                    syncInput.value = value;
                    syncDisplay.textContent = value.toFixed(decimals);
                  }
                  core.setParameterValueById(syncParam.id, value);
                  console.log(`‚úì Synced ${syncParam.id} to ${value}`);
                }
              }
            } catch (err) {
              console.error(`‚úó Failed to set ${param.id} to ${value}:`, err);
            }
          };
          
          // Initialize display
          valueDisplay.textContent = input.value;
        });
        
        // Reset button
        resetBtn.onclick = () => {
          Object.keys(customizationParams).forEach(key => {
            const input = document.getElementById(key);
            const valueDisplay = document.getElementById(key + 'Value');
            const param = customizationParams[key];
            
            if (!input || !valueDisplay) return;
            
            input.value = 0;
            valueDisplay.textContent = '0';
            
            try {
              core.setParameterValueById(param.id, 0);
            } catch (err) {
              console.warn(`Failed to reset ${param.id}:`, err);
            }
          });
        };
        
        console.log('Customization controls initialized');
      }
      
      // Audio unlock for browsers with autoplay restrictions
      let audioUnlocked = false;
      function unlockAudio() {
        if (audioUnlocked) return;
        const audio = new Audio();
        audio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
        audio.play().then(() => {
          audioUnlocked = true;
          console.log('Audio unlocked');
        }).catch(() => {});
      }
      
      // Unlock audio on any user interaction
      document.body.addEventListener('click', unlockAudio, { once: true });
      document.body.addEventListener('touchstart', unlockAudio, { once: true });
      
      // Initialize
      (async () => {
        // Check authentication first
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) return;
        
        // Wire up logout button
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        live2dController = await initLive2D();
        
        // Initialize mouth driver and emotion layer
        if (live2dController && live2dController.core) {
          mouthDriver = new MouthAmplitudeDriver(live2dController.core);
          emotionLayer = makeEmotionApplier(live2dController.core);
          console.log('Live2D animation systems initialized');
        }
        
        // Setup customization controls
        setupCustomization();
        
        await loadConversations();
        
        // Create first conversation if none exist
        const hasConversations = conversationList.children.length > 0;
        if (!hasConversations) {
          await createNewConversation();
        }
      })();
    </script>
  </body>
</html>

